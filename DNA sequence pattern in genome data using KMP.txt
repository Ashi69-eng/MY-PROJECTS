#include <stdio.h>
#include <string.h>
#include <time.h>
#include <ctype.h>
#include <stdlib.h>

#define MAX_GENOME 10000
#define MAX_PATTERN 100

void toUpperStr(char *s) {
    for (int i = 0; s[i] != '\0'; i++)
        s[i] = (char)toupper((unsigned char)s[i]);
}

int isValidDNA(const char *s) {
    for (int i = 0; s[i] != '\0'; i++) {
        char c = s[i];
        if (c!='A' && c!='T' && c!='G' && c!='C')
            return 0;
    }
    return 1;
}

double gcContent(const char *s) {
    int gc = 0, n = strlen(s);
    if (n == 0) return 0.0;
    for (int i = 0; i < n; i++)
        if (s[i] == 'G' || s[i] == 'C') gc++;
    return (100.0 * gc) / n;
}

void nucleotideFrequency(const char *s) {
    int A=0,T=0,G=0,C=0;
    for (int i = 0; s[i] != '\0'; i++) {
        if (s[i]=='A') A++;
        else if (s[i]=='T') T++;
        else if (s[i]=='G') G++;
        else if (s[i]=='C') C++;
    }
    printf("Base count         : A=%d  T=%d  G=%d  C=%d\n", A, T, G, C);
}

void generateRandomGenome(char *g, int n) {
    const char bases[4] = {'A','T','G','C'};
    for (int i = 0; i < n; i++)
        g[i] = bases[rand() % 4];
    g[n] = '\0';
}

int naiveSearch(const char *text, const char *pattern) {
    int n = strlen(text), m = strlen(pattern);
    int count = 0, found = 0;

    printf("\n[Naive Search Results]\n");
    for (int i = 0; i <= n-m; i++) {
        int j;
        for (j = 0; j < m; j++) {
            if (text[i+j] != pattern[j]) break;
        }
        if (j == m) {
            printf("Pattern found at index %d\n", i);
            count++;
            found = 1;
        }
    }
    if (!found) printf("Pattern not found!\n");
    printf("Total matches (Naive): %d\n", count);
    return count;
}

void computeLPSArray(const char *pattern, int m, int *lps) {
    int len = 0, i = 1;
    lps[0] = 0;
    while (i < m) {
        if (pattern[i] == pattern[len]) {
            len++; 
            lps[i] = len;
            i++;
        } else {
            if (len != 0)
                len = lps[len-1];
            else {
                lps[i] = 0;
                i++;
            }
        }
    }
}

int KMPSearch(const char *text, const char *pattern, int *matchMarks) {
    int n = strlen(text), m = strlen(pattern);
    int *lps = (int *)malloc(m * sizeof(int));
    int i = 0, j = 0, count = 0, found = 0;

    if (!lps) {
        printf("Memory allocation failed!\n");
        return 0;
    }

    computeLPSArray(pattern, m, lps);
    printf("\n[KMP Search Results]\n");

    while (i < n) {
        if (pattern[j] == text[i]) {
            i++;
            j++;
        }

        if (j == m) {
            int pos = i - j;
            printf("Pattern found at index %d\n", pos);
            matchMarks[pos] = 1;
            j = lps[j-1];
            count++;
            found = 1;
        } 
        else if (i < n && pattern[j] != text[i]) {
            if (j != 0) j = lps[j-1];
            else i++;
        }
    }

    if (!found) printf("Pattern not found!\n");
    printf("Total matches (KMP) : %d\n", count);

    free(lps);
    return count;
}

void highlightMatches(const char *text, const int *matchMarks) {
    int n = strlen(text);

    printf("\n[Genome Sequence]\n");
    printf("%s\n", text);

    printf("[Match Positions (^ = match start)]\n");
    for (int i = 0; i < n; i++)
        printf("%c", matchMarks[i] ? '^' : ' ');
    printf("\n");
}

int loadGenomeFromFile(char *genome) {
    char filename[256];
    printf("Enter genome file name: ");
    scanf("%255s", filename);

    FILE *fp = fopen(filename, "r");
    if (!fp) {
        printf("Error: cannot open file.\n");
        return 0;
    }

    if (fscanf(fp, "%10000s", genome) != 1) {
        printf("Error reading genome.\n");
        fclose(fp);
        return 0;
    }

    fclose(fp);
    return 1;
}

int main() {
    srand((unsigned int)time(NULL));
    int runAgain = 1;

    while (runAgain) {

        char genome[MAX_GENOME+1] = "";
        char pattern[MAX_PATTERN+1];
        int choice;

        printf("\n===== Gene Pattern Detector (KMP + Naive) =====\n");
        printf("1. Enter genome manually\n");
        printf("2. Load genome from file\n");
        printf("3. Generate random genome\n");
        printf("4. Exit\n");
        printf("Enter choice: ");
        if (scanf("%d", &choice) != 1) {
            printf("Invalid input.\n");
            return 1;
        }

        if (choice == 4) break;
        if (choice == 1) {
            printf("Enter genome sequence:\n");
            scanf("%s", genome);
        }
        else if (choice == 2) {
            if (!loadGenomeFromFile(genome)) continue;
        }
        else if (choice == 3) {
            int len;
            printf("Enter random genome length: ");
            scanf("%d", &len);
            if (len < 1 || len > MAX_GENOME) {
                printf("Invalid length.\n");
                continue;
            }
            generateRandomGenome(genome, len);
            printf("Random genome generated.\n");
        }
        else {
            printf("Invalid choice.\n");
            continue;
        }


        toUpperStr(genome);
        if (!isValidDNA(genome)) {
            printf("Invalid genome! Only A,T,G,C allowed.\n");
            continue;
        }

   
        printf("Enter pattern to search: ");
        scanf("%s", pattern);
        toUpperStr(pattern);

        if (!isValidDNA(pattern)) {
            printf("Invalid pattern! Only A,T,G,C allowed.\n");
            continue;
        }

        int n = strlen(genome);
        int m = strlen(pattern);

        if (m > n) {
            printf("Pattern longer than genome. Cannot search.\n");
            continue;
        }

        printf("\n===== DNA Statistics =====\n");
        printf("Genome length      : %d\n", n);
        printf("Pattern length     : %d\n", m);
        printf("GC content         : %.2f%%\n", gcContent(genome));
        nucleotideFrequency(genome);

        int *matchMarks = (int *)calloc(n, sizeof(int));
        if (!matchMarks) {
            printf("Memory allocation failed!\n");
            return 1;
        }

        clock_t start_naive = clock();
        int naiveCount = naiveSearch(genome, pattern);
        clock_t end_naive = clock();
        double naiveTime = (double)(end_naive - start_naive)/CLOCKS_PER_SEC;

        clock_t start_kmp = clock();
        int kmpCount = KMPSearch(genome, pattern, matchMarks);
        clock_t end_kmp = clock();
        double kmpTime = (double)(end_kmp - start_kmp)/CLOCKS_PER_SEC;

        highlightMatches(genome, matchMarks);

        printf("\n===== Performance Comparison =====\n");
        printf("Naive Time : %.6f sec\n", naiveTime);
        printf("KMP Time   : %.6f sec\n", kmpTime);

        if (naiveTime > kmpTime)
            printf("KMP is faster.\n");
        else if (naiveTime < kmpTime)
            printf("Naive is faster (small dataset effect).\n");
        else
            printf("Both performed equally.\n");

        if (naiveTime > 0)
            printf("KMP improvement: %.2f%%\n", ((naiveTime - kmpTime) / naiveTime) * 100.0);
        FILE *mf = fopen("matches.txt", "w");
        if (mf) {
            fprintf(mf, "Match positions:\n");
            for (int i = 0; i < n; i++)
                if (matchMarks[i]) fprintf(mf, "%d ", i);
            fclose(mf);
            printf("Match positions saved to matches.txt\n");
        }
        FILE *rp = fopen("report.txt", "w");
        if (rp) {
            fprintf(rp, "===== Gene Pattern Detector Report =====\n");
            fprintf(rp, "Genome length      : %d\n", n);
            fprintf(rp, "Pattern length     : %d\n", m);
            fprintf(rp, "Naive matches      : %d\n", naiveCount);
            fprintf(rp, "KMP matches        : %d\n", kmpCount);
            fprintf(rp, "Naive time (sec)   : %.6f\n", naiveTime);
            fprintf(rp, "KMP time   (sec)   : %.6f\n", kmpTime);
            fclose(rp);
            printf("Report saved to report.txt\n");
        }

        free(matchMarks);

        printf("\nRun again? (1=Yes, 0=No): ");
        if (scanf("%d", &runAgain) != 1) runAgain = 0;
    }

    printf("\nThank you for using Gene Pattern Detector!\n");
    return 0;
}















